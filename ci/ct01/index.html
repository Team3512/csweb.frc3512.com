<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="description" content="State Machines and PID Controllers">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PID Controllers - FRC Team 3512</title>
  <script src="../../js/toc.js"></script>
  <link rel="stylesheet" type="text/css" href="../../css/style.css">
  <link rel="shortcut icon" type="image/ico" href="../../favicon.ico">
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      extensions: ["tex2jax.js"],
      jax: ["input/TeX","output/HTML-CSS"],
      tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]}
    });
  </script>
  <script type="text/javascript" src="../../MathJax/MathJax.js"></script>
</head>
<body onload="tableOfContents();">
  <div id="content">
    <div class="title">
      <h1>PID Controllers<br>
      <small>Control Theory 1</small></h1>
    </div>
    <div class="prereq">
      <strong>Prerequisites:</strong> <a href="../cs01/">CS 1</a>
    </div>
    <div id="toc"></div>
    <h2 id="Labs">Labs</h2>
    <ul>
      <li>
        <a href="live-grapher/">LiveGrapher Lab</a>
      </li>
    </ul>
    <h2 id="Introduction">Introduction</h2>
    <p>A control system is a device, or set of devices, that manages, commands,
    directs or regulates the behavior of other devices or systems. On our
    robotics team, we have used two types: open loop and closed loop. Open loop
    controllers don't incorporate feedback from its output. An example would be
    the driver controlling the robot's speed directly with joysticks. Closed
    loop controllers are used to automate processes so the driver doesn't have
    to control them manually. Our 2015 robot, Talos, used a closed loop
    controller to seek to different elevator level presets automatically. The
    driver just needed to provide a level number. We used both state machines
    and PID controllers in that control system.</p>
    <h2 id="PID_Basics_and_Theory">PID Basics and Theory</h2>
    <p>Since Wikipedia does a good job explaining this, I'll refer to their
    resources on the topic. Read the introduction of <a href=
    "https://en.wikipedia.org/wiki/PID_controller">https://en.wikipedia.org/wiki/PID_controller</a>
    first. Then read the <a href=
    "https://en.wikipedia.org/wiki/PID_controller#Control_loop_basics">control
    loop basics</a> section for an example and further explanation. Continue to
    the next section on <a href=
    "https://en.wikipedia.org/wiki/PID_controller#PID_controller_theory">PID
    controller theory</a>. You can ignore the small part about the transfer
    function for now. I'll cover that in a module on state space representation
    at some point.</p>
    <h2 id="PID_Types">PID Types</h2>
    <p>PID controller inputs of different orders of derivatives, such as
    position and velocity, affect the system response differently. The position
    PID controller is defined as</p>
    <p>\[ u(t) = K_p e(t) + K_i \int_{0}^{t}e(\tau)d\tau + K_d \frac{de}{dt}
    \]</p>
    <p>If a velocity is passed instead, which is a change in position, the
    equation becomes</p>
    <p>\[ u'(t) = K_p \frac{de}{dt} + K_i \int_{0}^{t}\frac{de}{d\tau} d\tau +
    K_d \frac{d^{2}e}{dt^{2}} \]</p>
    <p>\[ u'(t) = K_p \frac{de}{dt} + K_i e(t) + K_d \frac{d^{2}e}{dt^{2}}
    \]</p>
    <p>This shows that K<sub>i</sub> produces a proportional response,
    K<sub>p</sub> produces a derivative response, and K<sub>i</sub> doesn't
    have an equivalent in the formula as-is. If we were to implement one, it
    would use a double integral. However, it would be of limited use since the
    K<sub>i</sub> term in the original equation also eliminates steady state
    error for step changes in reference. Relabelling the coefficients to match
    the position PID controller gives</p>
    <p>\[ u'(t) = K_p \int_{0}^{t}e(\tau) d\tau + K_d e(t) \]</p>
    <h2 id="Controller_Tuning">Controller Tuning</h2>
    <p>Since the team started, we've been tuning PID controllers manually.</p>
    <h3 id="Position_PID_tuning">Position PID tuning</h3>
    <ol>
      <li>Set K<sub>p</sub>, K<sub>i</sub>, and K<sub>d</sub> to zero.</li>
      <li>Increase K<sub>p</sub> until the output starts to oscillate around
      the reference.</li>
      <li>Increase K<sub>d</sub> as much as possible without introducing
      jitteriness and instability in the response.</li>
      <li>
        <p>If the controller settles at an output above or below the reference,
        increase K<sub>i</sub> such that the controller reaches the reference
        in a reasonable time.</p>
        <blockquote>
          <i>Note:</i> Adding an integral gain to the controller is an
          incorrect way to eliminate steady state error. A better approach
          would be to tune it with an integrator added to the plant, but this
          requires a system model. Since we are doing output-based rather than
          model-based control, our only option is to add an integrator to the
          controller.
        </blockquote>
        <p>Beware that if K<sub>i</sub> is too large integral windup can occur.
        As the <a href=
        "Modifications%20to%20the%20PID%20algorithm">Modifications to the PID
        algorithm</a> section of the Wikipedia page states:</p>
        <blockquote>
          "Following a large change in setpoint the integral term can
          accumulate an error larger than the maximal value for the regulation
          variable (windup), thus the system overshoots and continues to
          increase until this accumulated error is unwound."
        </blockquote>
        <p>Basically, a lot of error is accumulated and it takes a while for
        the error to unwind so the controller can start heading back toward the
        reference.</p>
      </li>
    </ol>
    <h3 id="Velocity_PID_tuning">Velocity PID tuning</h3>
    <ol>
      <li>Set K<sub>p</sub>, K<sub>i</sub>, and K<sub>d</sub> to zero.</li>
      <li>Increase K<sub>i</sub> until the output starts to oscillate around
      the reference.</li>
      <li>Increase K<sub>p</sub> as much as possible without introducing
      jitteriness and instability in the response.</li>
    </ol>
    <p>There is no equivalent to position PID's integral term in velocity PID,
    but one isn't needed. A velocity controller will not have steady state
    error for step inputs because the K<sub>i</sub> introduces a pole in the
    controller.</p>
    <h3 id="Other_Notes">Other Notes</h3>
    <p>Tuning in this way can require some intuition as to what values produce
    the desired response. An alternative would be using an auto-tuner that
    follows something like the <a href=
    "https://en.wikipedia.org/wiki/Ziegler%E2%80%93Nichols_method">Ziegler-Nichols
    method</a>.</p>
    <p>We've used <a href=
    "https://github.com/Team3512/LiveGrapher/">LiveGrapher</a> in the past to
    visualize the system response so we can more effectively tune it. We've
    used it in a production environment with our robots since 2013. The server
    side of LiveGrapher is in the <a href=
    "https://github.com/Team3512/RobotModules">RobotModules</a> repository.</p>
    <h2 id="Limitations_of_PID_control">Limitations of PID control</h2>
    <p>Read Wikipedia's section on the <a href=
    "https://en.wikipedia.org/wiki/PID_controller#Limitations_of_PID_control">limitations
    of PID control</a>.</p>
    <p>Continuing from the section to which I just linked, another example of a
    non-linear system is an elevator/carriage assembly which has to operate
    under gravity. One can have two sets of PID constants for travelling in
    each direction. We did this on our 2015 robot. A better approach would be
    applying a feedforward to compensate for gravity, thus making the system
    linear again. One just needs to determine an approximate motor value to add
    to the output to make the system maintain its position under load.</p>
    <p>For fixing noise in the derivative, we've used a rolling average filter
    and a Kalman filter. The latter works better but requires tuning. I'll
    cover each in <a href="../ct05/">CT 5</a> and <a href=
    "../ct04/kalman-filter/">CT 4</a> respectively.</p>
    <p>The section on <a href=
    "https://en.wikipedia.org/wiki/PID_controller#Modifications_to_the_PID_algorithm">
    modifications to the PID algorithm</a> is interesting, but one won't need
    it unless one is modifying his or her PID controller. I've been working to
    get some of those modifications integrated into WPILib's PIDController
    class.</p>
  </div>
</body>
</html>
